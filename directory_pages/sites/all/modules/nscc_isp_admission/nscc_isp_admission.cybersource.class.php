<?php

/**
 *		Merchant account number
 *		Contact district accounting for anything related to this.
 */
define( 'MERCHANT_ID', 'v5166380' );


/**
 *		Transaction Key
 *		Generated using a utility in the Cybersource Business Center
 *		(https://ebc.cybersource.com/ebc/login/Login.do)
 */
//define('TRANSACTION_KEY', 'NzFgcJ34HSZpTIC2578BaPmfXkhS8WicuvL8Tnz0sUQY/AK03HByY6hOrZAOFP/qhRvwPc7lYzucBCKxoeb6QVmdR+Vcu/sEb+piRe34j5WLV/AtEMk7zXex2qkYUXVPhLtqb+MT2xRSZIkPMaglzxbvVP7wha1UivQaruYyue4qzGLsnwhxvGhcztPbEnX96J9eSFLxaJy68vxOfPSxRBj8ArTccHJjqE6tkA4U/+qFG/A9zuVjO5wEIrGh5vpBWZ1H5Vy7+wRv6mJF7fiPlYtX8C0QyTvNd7HaqRhRdU+Eu2pv4xPbFFJkiQ8xqCXPFu9U/vCFrVSK9Bqu5jK57g==');
//define('TRANSACTION_KEY', 'bjIbavzXLvNU04bKnW5E5MXTybXjRUQPHI5JcXRpwLEbeYBK8QbfXJ3tA/lOY/igIHbzNPtEM9lzxI84haWqBIOZNn1vHgahnllFKSecEmq3/OtP712IzGVe6GTcFUF6cYcumzAKGslegMJedW2YEVGbnocngsOnlBB0Xkzr8+50oZfRR1wcIYaOliNus7UknB1QLgC8VZjozx9RRlzLcAu54bO/m2NU3YW20WFIC5HBUCiTjz6IncDMyar7AZrRglV2GgzGk68PpGtoY8IGenPWRI1LFPcdQHRjn9PIKjOZndo5ifE+tU+Ar8EIELcIlfF5GoplriYtUh3L/aVSCg==');
//this key never worked -- define('TRANSACTION_KEY', 'MIIEvwIBADANBgkqhkiG9w0BAQEFAASCBKkwggSlAgEAAoIBAQDijA/w9Z409eh2FKBIaLulaWh9eBZzPIEirflmTgur7D3PZK88dNuUqULZPVJAnWiu/1Hz6WAH6FL6W1sAAGyax9vIzpkrwNcuUXVxhxrY6iaAoH8eJ5HwHCNp6OKiX0fo9Lvt2D3aIbYwlVrxcjguGEYbClhyLOMfJGFVTwx+Vq2UapQUaCeTtP4T64xKhvas2AIdKQpFxIKFdkSWFtCT8fs+9w68vGIoPZkSr3gyp+UrCYstYzuS1Tskn46txyMeFWaTDXEnuqYmPQttDeLqV0Omh2chSSn2wzgOhdGiA8JCAo6iI8Se6SN4F1B66/QeHfF8RHdonKgqktPbW0SNAgMBAAECggEAd1XER+96CPfIHfs7eykAP1/JFN6fJNCoTXZLO6K87zEgVhD5ZeVAjYyjk/+DRlokfJott0glt8SfgRWCV/vhOZ8xnROHB88rClEKhmTetYiSA4uHqoC5lTudQ/rS9yktnf7cx6ry2eaMLAdgwnKiOVW8CB5o/Ku8b/kf9GoRcLKGPpsTHEisSUqCkJTeyaLCcUCGDlYWWE5cpKSbBmxtGMg/mxRWBrgBJUsV8too+wdyZgSpiwvAgJbSqzceJoPwqIJmu98SHwUENhwkOADAOosQysMO9z/qQrEQ2+12AxIgvhVsdVrMhUTy5BZ6LMEbIY0LrbGCeGndn1kO9oiYwQKBgQDzUq1Lnih3pIqoDuV7zC5WWn8yoA3U2tR32Sii8sI/mvBKYb97SRBBRCH4KXbkrrK7PjDlmjm3ll7qrGxhko6vZFdY/JCOYbKMHIfJoiOG9TSMJMVSc3NeR8++tQgZrE9wvfANviQ79vLuXt8CqZ0YTgVSE2Dur4lM0RRKsXF3GQKBgQDuWaMq5LZrxUqM3zGVaAON6olnAwuKvP42lJ+ezDGzrvHgxg0izTjzdCVkn3rXygRH6uzZmsaYZ/aQhl1+fMdqVYkU+MKi+/bI36jAfmyW7mwe+FWE2/91u4hpVuStO6HPgTVpc6DWiKg9MEl5+b42KMFcsaBsCkYFCc02bIXrlQKBgQDmpcllc59yggN5eN1pc0u9SX1nVLanvWNH1A6kH6+oMUtzhqLGz6Rb6aS1o0BzV3JO8Y3SJ1Zsw1pn41e9Sfp9IYV28bppbQydqfHBXTOGG2tbKQPuu0dx6GpxoRLzmxWWjkU+Ea4xNU5kTIPi9zrVrid2/K2Ws8hXi51LjFY9CQKBgQDAK0cx4xrtAzFbKOyKQEV1W16SzlK09jGkAeo8FvgPngJoLmYS5BGBv+gSG77oUnlnHpL90xtBb7jMx3iD7ci+A961KOeMjsdnJ2SgZo3YlrxXr/MLXnC2FJAkFinjPcv1SICu18oaji3Ov6rODDx+4BceTBxCX3oav89TjOXgjQKBgQDWPnoKIxfE3teUhdVwgHYoSf4wQY78brwviW0Bsl/SEvvqULe5JF5PuiXxat90YuhfL23Ge8Y6/AF01e/EvlklSA91MB6Thoi8C4XU7qlYkqY/IOdKgplTDZT5G5rEX358VN+BTwL9+xBN3UiCAp/XYxCJXwrs/S7aJK2taj0RmQ==');
define('TRANSACTION_KEY', 'rGsHzUmLOCEonDaD4LvcskvZwZPdfvlfUuQIQaDto9DqpiGyWFrhjMuxGSGUltQg3bjgxpAih3AHlj93SBdwD/Rhn7pQPyTB60gCLtUkvpTnc1xBzF7H/clM3R3/pXaqmbHzN1on0KdygyMdMb+J6I0Wyh0rxUEHhpXuYPCORv6r2EUfRiBgfFAUyYmUPWB5pX6RbnTsOMVRO+dSN2PMWJwY0OEcerhY2y54MOySWSFeOUraKTmh2fFxYvSdG2WyfhA2lPnysfn9xgfqmzs0ICwB7OjZM1H4dkWYjijS3HEPI5VS5h8EyKsZOpj9n1PSvvYNkEQTDWC/UaTk5qbDgQ==');

/**
 *		WSDL
 *		Cybersource periodically releases new versions of these without warning.
 *		However, they recommend that we always use the lateset version so	we'll
 *		need to manually check the latest version, or write a script to do so
 *		automatically since they do not provide a dynamic WSDL service.
 */
//define('WSDL_URL', 'https://ics2wstest.ic3.com/commerce/1.x/transactionProcessor/CyberSourceTransaction_1.67.wsdl');	//test
define('WSDL_URL', 'https://ics2ws.ic3.com/commerce/1.x/transactionProcessor/CyberSourceTransaction_1.67.wsdl');	//production


/**
 *		SOAP client derivitive
 *		Adds Cybersource-specific data to SOAP transactions.
 *		@see PHP documentation (http://us.php.net/manual/en/class.soapclient.php)
 *		@see Cybersource documentation (http://www.cybersource.com/developers/develop/integration_methods/simple_order_and_soap_toolkit_api/).
 */
class CybersourceClient extends SoapClient {

   function __construct($wsdl, $options = null) { parent::__construct($wsdl, $options); }

	// This section inserts the UsernameToken information in the outgoing SOAP message.
   function __doRequest($request, $location, $action, $version, $oneWay = 0) {

     $user = MERCHANT_ID;
     $password = TRANSACTION_KEY;     
     $soapHeader = "<SOAP-ENV:Header xmlns:SOAP-ENV=\"http://schemas.xmlsoap.org/soap/envelope/\" xmlns:wsse=\"http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-secext-1.0.xsd\"><wsse:Security SOAP-ENV:mustUnderstand=\"1\"><wsse:UsernameToken><wsse:Username>$user</wsse:Username><wsse:Password Type=\"http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-username-token-profile-1.0#PasswordText\">$password</wsse:Password></wsse:UsernameToken></wsse:Security></SOAP-ENV:Header>";
     $requestDOM = new DOMDocument('1.0');
     $soapHeaderDOM = new DOMDocument('1.0');

     try {

         $requestDOM->loadXML($request);
			$soapHeaderDOM->loadXML($soapHeader);

			$node = $requestDOM->importNode($soapHeaderDOM->firstChild, true);
			$requestDOM->firstChild->insertBefore($node, $requestDOM->firstChild->firstChild);

         $request = $requestDOM->saveXML();

			//watchdog('IP Module', 'Modified SOAP Request: <pre>'.print_r($request,true)."</pre>\n");

     } catch (DOMException $e) {
         die( 'Error adding UsernameToken: ' . $e->code);
     }

     return parent::__doRequest($request, $location, $action, $version, $oneWay = 0);
   }
}
