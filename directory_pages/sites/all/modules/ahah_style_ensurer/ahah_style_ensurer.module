<?php
// $Id: ahah_style_ensurer.module,v 1.1.2.2 2009/05/05 03:05:24 effulgentsia Exp $

/**
 * @file
 * Ensures that additional css files needed by content retrieved using AHAH get loaded.
 *
 * A challenge with using AHAH is that the content sent back to the browser is not a
 * complete page, but just a fragment inside of a JSON object, and this fragment does
 * not include <link> tags added using drupal_add_css(). Therefore, if the new content
 * requires a css file that wasn't added as part of the initial page, it
 * doesn't work. 
 * 
 * This module solves the above challenge by using the ahah_page_storage module to 
 * keep track of what css files have already been sent back to the page, and it sends
 * any new css files generated by the current request in a "styles" property of the
 * AHAH response object. This module's javascript file takes care of loading
 * those new css files.
 */
 
/**
 * Implementation of hook_form_alter
 */
function ahah_style_ensurer_form_alter(&$aForm, $aFormState, $sFormId) {
  $aForm['#after_build'][] = 'ahah_style_ensurer_after_form_build';
}

/**
 * Implementation of form's #after_build
 */
function ahah_style_ensurer_after_form_build($aForm, $aFormState) {
  // We want to add this module's javascript file, but only on pages
  // that use AHAH, and only after ahah.js has been added.
  static $bJsAdded;
  if (!$bJsAdded) {
    $aJavascript = drupal_add_js(NULL);
    if (isset($aJavascript['module']['misc/ahah.js'])) {
      $sPath = drupal_get_path('module', 'ahah_style_ensurer');
      drupal_add_js($sPath . '/ahah_style_ensurer.js');
      $bJsAdded = TRUE;
    }
  }
  return $aForm;
}

/**
 * Implementation of hook_preprocess_page()
 */
function ahah_style_ensurer_preprocess_page(&$aVars) {
  $aJavascript = drupal_add_js(NULL);
  if (isset($aJavascript['module']['misc/ahah.js'])) {
    $aStorage = ahah_page_storage();
    $aStorage['ahah_style_ensurer'] = drupal_add_css();
    ahah_page_storage($aStorage);
  }
}

/**
 * Implementation of hook_preprocess_ahah_response()
 */
function ahah_style_ensurer_preprocess_ahah_response(&$aVars) {
  $aCss = drupal_add_css();
  $aStorage = ahah_page_storage();
  $aCssCumulative = $aStorage['ahah_style_ensurer'];
  $aCssNew = array();
  foreach ($aCss as $sMedia => $aCssForMedia) {
    foreach ($aCssForMedia as $sType => $aCssForType) {
      foreach ($aCssForType as $sFile => $bPreprocess) {
        if (!isset($aCssCumulative[$sMedia][$sType][$sFile])) {
          $aCssCumulative[$sMedia][$sType][$sFile] = $bPreprocess;
          // drupal_get_css() triggers errors if we don't have 'module'
          // and 'theme' keys for each media.
          if (!isset($aCssNew[$sMedia]['module']) || !is_array($aCssNew[$sMedia]['module'])) {
            $aCssNew[$sMedia]['module'] = array();
          }
          if (!isset($aCssNew[$sMedia]['theme']) || !is_array($aCssNew[$sMedia]['theme'])) {
            $aCssNew[$sMedia]['theme'] = array();
          }
          $aCssNew[$sMedia][$sType][$sFile] = $bPreprocess;
        }
      }
    }
  }
  if (!empty($aCssNew)) {
    $aStorage['ahah_style_ensurer'] = $aCssCumulative;
    ahah_page_storage($aStorage);
    $aVars['response']['styles'] = drupal_get_css($aCssNew);
  }
}
