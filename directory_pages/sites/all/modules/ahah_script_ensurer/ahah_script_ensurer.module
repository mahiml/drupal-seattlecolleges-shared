<?php
// $Id: ahah_script_ensurer.module,v 1.1.2.1 2009/04/27 02:52:34 effulgentsia Exp $

/**
 * @file
 * Ensures that additional javascript files needed by content retrieved using AHAH get loaded.
 *
 * A challenge with using AHAH is that the content sent back to the browser is not a
 * complete page, but just a fragment inside of a JSON object, and this fragment does
 * not include <script> tags added using drupal_add_js(). Therefore, if the new content
 * requires a javascript file that wasn't added as part of the initial page, it
 * doesn't work. The general AHAH paradigm (using, for example, the cck and ahah_helper
 * modules as reference material) is that only 'settings' added with drupal_add_js()
 * are returned.
 * 
 * This module solves the above challenge by using the ahah_page_storage module to 
 * keep track of what scripts have already been sent back to the page, and it sends
 * any new scripts generated by the current request in a "scripts" property of the
 * AHAH response object. This module's javascript file takes care of loading
 * those new scripts.
 */
 
/**
 * Implementation of hook_form_alter
 */
function ahah_script_ensurer_form_alter(&$aForm, $aFormState, $sFormId) {
  $aForm['#after_build'][] = 'ahah_script_ensurer_after_form_build';
}

/**
 * Implementation of form's #after_build
 */
function ahah_script_ensurer_after_form_build($aForm, $aFormState) {
  // We want to add this module's javascript files, but only on pages
  // that use AHAH, and only after ahah.js has been added.
  static $bJsAdded;
  if (!$bJsAdded) {
    $aJavascript = drupal_add_js(NULL);
    if (isset($aJavascript['module']['misc/ahah.js'])) {
      $sPath = drupal_get_path('module', 'ahah_script_ensurer');
      drupal_add_js($sPath . '/misc/jquery.seqpar.js');
      drupal_add_js($sPath . '/ahah_script_ensurer.js');
      $bJsAdded = TRUE;
    }
  }
  return $aForm;
}

/**
 * Implementation of hook_preprocess_page()
 */
function ahah_script_ensurer_preprocess_page(&$aVars) {
  $aJavascript = drupal_add_js(NULL);
  if (isset($aJavascript['module']['misc/ahah.js'])) {
    $aStorage = ahah_page_storage();
    $aStorage['ahah_script_ensurer'] = $aJavascript;
    ahah_page_storage($aStorage);
  }
}

/**
 * Implementation of hook_preprocess_ahah_response()
 */
function ahah_script_ensurer_preprocess_ahah_response(&$aVars) {
  $aJavascript = drupal_add_js(NULL);
  $aStorage = ahah_page_storage();
  $aJavascriptCumulative = $aStorage['ahah_script_ensurer'];
  $aJavascriptNew = array();
  foreach ($aJavascript as $sType => $aJavascriptForType) {
    if (!in_array($sType, array('setting', 'inline'))) {
      foreach ($aJavascriptForType as $sFile => $aInfo) {
        if (!isset($aJavascriptCumulative[$sType][$sFile])) {
          $aJavascriptCumulative[$sType][$sFile] = $aInfo;
          $aJavascriptNew[$sType][$sFile] = $aInfo;
        }
      }
    }
  }
  if (!empty($aJavascriptNew)) {
    $aStorage['ahah_script_ensurer'] = $aJavascriptCumulative;
    ahah_page_storage($aStorage);
    $aVars['response']['scripts'] = module_exists('jsalter') ? jsalter_get_js('header', $aJavascriptNew) : drupal_get_js('header', $aJavascriptNew);
  }
}
